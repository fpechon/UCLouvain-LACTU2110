# Brief Introduction to R and Descriptive Analysis of the Dataset

In this document, we will briefly introduce R and installing all the required packages for this course. A descriptive analysis of the dataset is then operated.

## Installing the required packages

The following commands will load the package if they are already installed. If they are not yet installed, they will be installed and loaded afterwards. Note that for Windows users, Rtools is required for some packages (e.g., CASdatasets). This list may not be exhaustive and other packages may be required in other notebooks.


```R
if (!require("xts")) install.packages("xts")
if (!require("CASdatasets")) install.packages("CASdatasets", repos = "http://cas.uqam.ca/pub/", type="source")
if (!require("caret")) install.packages("caret")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("mgcv")) install.packages("mgcv")
if (!require("dplyr")) install.packages("dplyr")
if (!require("gridExtra")) install.packages("gridExtra")
if (!require("visreg")) install.packages("visreg")
if (!require("MASS")) install.packages("MASS")
if (!require("plotrix")) install.packages("plotrix")
if (!require("rgeos")) install.packages("rgeos", type="source")
if (!require("rgdal")) install.packages("rgdal", type="source")
if (!require("xtable")) install.packages("xtable")
if (!require("maptools")) install.packages("maptools")
if (!require("scales")) install.packages("scales")
if (!require("broom")) install.packages("broom")
if (!require("stringi")) install.packages("stringi")
if (!require("arrow")) install.packages("arrow")


require("CASdatasets")
require("ggplot2")
require("mgcv")
require("caret")
require("gridExtra")
require("dplyr")
require("visreg")
require("MASS")
require("plotrix")
require("rgdal")
require("rgeos")
require("xtable")
require("maptools")
require("scales")
require("broom")
require("stringi")
require("arrow");
```

In this jupyter notebook, we will use the following options to set the width and height of our plots.


```R
options(repr.plot.width = 8, repr.plot.height = 4, repr.plot.res = 250)
```

## Getting started with the dataset
### Loading the dataset

We will now load a dataset from the **CASdatasets** package. In case you were not able to install the **CASdatasets** package, we also provide a parquet file of the dataset (see more on that below).

We can simply load the dataset with the following command:


```R
data("freMTPLfreq")
```

To keep it simple and illustrative, we will only keep a subset of this dataset. Each line corresponds to a policy. We will restrict ourself to the policies covering a vehicle aged between 0 and 25 years. Also, we will only keep policies that were covered for a maximum of one year.

We will use the **tidyverse** univers in this course, as it can be easier to read (and writing clear code is important!). Subsetting can be done with the **filter** function.


```R
dataset = freMTPLfreq %>% filter(Exposure<=1 & Exposure >= 0 & CarAge<=25)
```

Note the *pipe* operator which allows to chain operations. We could also have written the following. We check that we obtain the same result with the **all.equal(dataset, dataset_alternative)** function. To save some memory we then remove the alternative dataset.


```R
dataset_alternative = freMTPLfreq %>% 
                                filter(Exposure <= 1) %>% 
                                filter(Exposure >= 0) %>% 
                                filter(CarAge<=25)

sprintf("Are the two datasets equal ? %s", ifelse(all.equal(dataset, dataset_alternative), "Yes", "No"))
rm(dataset_alternative)
```


'Are the two datasets equal ? Yes'



```R
write_parquet(dataset, sink = "../data/dataset.parquet", compression = "gzip")
```

We will save the dataset into a *parquet* file, so we don't need to load the CASdatasets package anymore and filter the data.

For those that could not install this package, now is the time to load the provided *parquet* file.


```R
dataset = read_parquet(file = "../data/dataset.parquet")
```

### Checking the dataset

We can check that the dataset is correctly loaded with the following functions.A good idea is to check whether the dataset has been loaded correctly. To do this, the following tools can be used:

 - **head** allows to visualize the first 6 lines of the dataset.


```R
head(dataset)
```


<table class="dataframe">
<caption>A data.frame: 6 Ã— 10</caption>
<thead>
	<tr><th></th><th scope=col>PolicyID</th><th scope=col>ClaimNb</th><th scope=col>Exposure</th><th scope=col>Power</th><th scope=col>CarAge</th><th scope=col>DriverAge</th><th scope=col>Brand</th><th scope=col>Gas</th><th scope=col>Region</th><th scope=col>Density</th></tr>
	<tr><th></th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td>1</td><td>0</td><td>0.09</td><td>g</td><td>0</td><td>46</td><td>Japanese (except Nissan) or Korean</td><td>Diesel </td><td>Aquitaine         </td><td>  76</td></tr>
	<tr><th scope=row>2</th><td>2</td><td>0</td><td>0.84</td><td>g</td><td>0</td><td>46</td><td>Japanese (except Nissan) or Korean</td><td>Diesel </td><td>Aquitaine         </td><td>  76</td></tr>
	<tr><th scope=row>3</th><td>3</td><td>0</td><td>0.52</td><td>f</td><td>2</td><td>38</td><td>Japanese (except Nissan) or Korean</td><td>Regular</td><td>Nord-Pas-de-Calais</td><td>3003</td></tr>
	<tr><th scope=row>4</th><td>4</td><td>0</td><td>0.45</td><td>f</td><td>2</td><td>38</td><td>Japanese (except Nissan) or Korean</td><td>Regular</td><td>Nord-Pas-de-Calais</td><td>3003</td></tr>
	<tr><th scope=row>5</th><td>5</td><td>0</td><td>0.15</td><td>g</td><td>0</td><td>41</td><td>Japanese (except Nissan) or Korean</td><td>Diesel </td><td>Pays-de-la-Loire  </td><td>  60</td></tr>
	<tr><th scope=row>6</th><td>6</td><td>0</td><td>0.75</td><td>g</td><td>0</td><td>41</td><td>Japanese (except Nissan) or Korean</td><td>Diesel </td><td>Pays-de-la-Loire  </td><td>  60</td></tr>
</tbody>
</table>



- **str** allows to see the format of the different variables. We will typically distinguish numerical variables (real numbers or integers) and factors (categorical data).


```R
str(dataset)
```

    'data.frame':	410864 obs. of  10 variables:
     $ PolicyID : Factor w/ 413169 levels "1","2","3","4",..: 1 2 3 4 5 6 7 8 9 10 ...
     $ ClaimNb  : int  0 0 0 0 0 0 0 0 0 0 ...
     $ Exposure : num  0.09 0.84 0.52 0.45 0.15 0.75 0.81 0.05 0.76 0.34 ...
     $ Power    : Factor w/ 12 levels "d","e","f","g",..: 4 4 3 3 4 4 1 1 1 6 ...
     $ CarAge   : int  0 0 2 2 0 0 1 0 9 0 ...
     $ DriverAge: int  46 46 38 38 41 41 27 27 23 44 ...
     $ Brand    : Factor w/ 7 levels "Fiat","Japanese (except Nissan) or Korean",..: 2 2 2 2 2 2 2 2 1 2 ...
     $ Gas      : Factor w/ 2 levels "Diesel","Regular": 1 1 2 2 1 1 2 2 2 2 ...
     $ Region   : Factor w/ 10 levels "Aquitaine","Basse-Normandie",..: 1 1 8 8 9 9 1 1 8 6 ...
     $ Density  : int  76 76 3003 3003 60 60 695 695 7887 27000 ...
    

- **summary** allows to compute for each variable some summary statistics.


```R
summary(dataset)
```


        PolicyID         ClaimNb           Exposure            Power      
     1      :     1   Min.   :0.00000   Min.   :0.002732   f      :95432  
     2      :     1   1st Qu.:0.00000   1st Qu.:0.200000   g      :90663  
     3      :     1   Median :0.00000   Median :0.530000   e      :76784  
     4      :     1   Mean   :0.03925   Mean   :0.559997   d      :67660  
     5      :     1   3rd Qu.:0.00000   3rd Qu.:1.000000   h      :26558  
     6      :     1   Max.   :4.00000   Max.   :1.000000   j      :17978  
     (Other):410858                                        (Other):35789  
         CarAge         DriverAge                                   Brand       
     Min.   : 0.000   Min.   :18.0   Fiat                              : 16653  
     1st Qu.: 3.000   1st Qu.:34.0   Japanese (except Nissan) or Korean: 79031  
     Median : 7.000   Median :44.0   Mercedes, Chrysler or BMW         : 19087  
     Mean   : 7.413   Mean   :45.3   Opel, General Motors or Ford      : 37287  
     3rd Qu.:12.000   3rd Qu.:54.0   other                             :  9738  
     Max.   :25.000   Max.   :99.0   Renault, Nissan or Citroen        :216684  
                                     Volkswagen, Audi, Skoda or Seat   : 32384  
          Gas                        Region          Density     
     Diesel :205299   Centre            :159426   Min.   :    2  
     Regular:205565   Ile-de-France     : 69576   1st Qu.:   67  
                      Bretagne          : 41986   Median :  288  
                      Pays-de-la-Loire  : 38541   Mean   : 1987  
                      Aquitaine         : 31211   3rd Qu.: 1414  
                      Nord-Pas-de-Calais: 27111   Max.   :27000  
                      (Other)           : 43013                  


If one needs some **help** on a function, typing a question mark and the name of the function in the console opens the help file of the function. For instance,


```R
?head
```

## Descriptive Analysis of the dataset

We will now proceed with a descriptive analysis of this dataset. We will now have a descriptive analysis of the portfolio. The different variables available are


```R
names(dataset)
```


<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'PolicyID'</li><li>'ClaimNb'</li><li>'Exposure'</li><li>'Power'</li><li>'CarAge'</li><li>'DriverAge'</li><li>'Brand'</li><li>'Gas'</li><li>'Region'</li><li>'Density'</li></ol>



### PolicyID
The variable *PolicyID* related to a unique identifier of the policy. We can check that every policy appears only once in the dataset


```R
length(unique(dataset$PolicyID)) == nrow(dataset)
```


TRUE


Another possibility is to check the frequency of each *PolicyID* using the function *table*. The result is a table that shows for each *PolicyID* the corresponding number of lines in the dataset. We can then use a second time the function *table* in this result to show the frequency. We expect to have only **ones** (with possibily zeros), meaning each *PolicyID* has a unique line.


```R
table(table(dataset$PolicyID))
```


    
         0      1 
      2305 410864 


**To what corresponds the 0 ?** 

It appears that in this dataset the variable *PolicyID* is a **factor**. A factor variable has different *levels*. It appears that some PolicyID may be missing here (removed from the dataset, probably when we filtered out some policies). It is as if we had a 3-level categorical variable, for instance, color of a car, which takes three possible values: red, blue, gray, but in our dataset, we would only have red and blue cars. Gray would still be a level, but with no observation (i.e. no row) corresponding to a gray car.

To remove unused levels, we can use on the function **droplevels**.

### Exposure in month
The Exposure reveals the fraction of the year during which the policyholder is in the portfolio. 
We can compute the total exposure by summing the policyholders' exposures. 
Here we find:


```R
sprintf("%s years",scales::number(sum(dataset$Exposure), accuracy = 0.1))
```


'230 082.6 years'


We can show the number of months of exposure on a table. The function *cut* allows to categorize (bin) a numerical variable. We can specify where to 'break' and give a name to each level using the *labels* argument. The output is a factor variable.


```R
table_exposures = table(cut(dataset$Exposure, breaks = seq(from = 0, to = 1,by = 1/12), labels = 1:12))
table_exposures
```


    
         1      2      3      4      5      6      7      8      9     10     11 
     62633  29216  33452  24213  19463  29565  18835  14438  21518  13653  12422 
        12 
    131456 


Using the function *prop.table*, it is possible to represent this information in relative terms show the number of months of exposure on a table.


```R
Exposures_prop = prop.table(table_exposures)
round(Exposures_prop, 4)*100
```


    
        1     2     3     4     5     6     7     8     9    10    11    12 
    15.24  7.11  8.14  5.89  4.74  7.20  4.58  3.51  5.24  3.32  3.02 32.00 


Alternatively, we can use a barplot, using **ggplot2** !


```R
ggplot(dataset)+geom_bar(aes(x=cut(Exposure,
                                   breaks = seq(from = 0, to = 1,by = 1/12), labels = 1:12))) + 
  scale_x_discrete(name = "Number of months") + 
  scale_y_continuous(name = "Number of Policies", label = label_number()) + 
  ggtitle("Exposure in months")
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_36_0.png)
    


What if we also want to show the percentage on the bars ?


```R
ggplot(dataset, aes(x=cut(Exposure, breaks = seq(from = 0, to = 1,by = 1/12), labels = 1:12), 
                    label = scales::percent(prop.table(stat(count)), accuracy = 0.1)))+
  geom_bar() + 
  geom_text(stat = 'count',
            vjust = -0.5,
            size = 3) +
  scale_x_discrete(name = "Number of months") + 
  scale_y_continuous(name = "Number of Policies", 
                     label = label_number()) + 
  ggtitle("Exposure in months")
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_38_0.png)
    


Note that a barplot is used to plot factor variables (categorical variables). In our case, we categorized the variable Exposure using the function *cut*. If we do not want to categorize this variable, we should use a histogram. We can specify the number of bins (= 12) or the binwidth (= 1/12).


```R
ggplot(dataset, aes(x=Exposure))+geom_histogram(binwidth =1/12, fill='gray', color='white') +
  scale_x_continuous(name = "Exposure in fraction of years", breaks=seq(0,1,1/12), labels = round(seq(0,1,1/12), 3))+
  scale_y_continuous(name = 'Number of Polices', labels = label_number()) + 
  ggtitle("Exposure in fraction of years")
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_40_0.png)
    


If you are not familiar with ggplot, I could recommend this cheat-sheet: https://github.com/rstudio/cheatsheets/blob/main/data-visualization-2.1.pdf

### Number of claim : ClaimNb



```R
ggplot(dataset, aes(x=ClaimNb))+
  geom_bar()+
  geom_label(stat='count', 
             aes(label =  percent(prop.table(after_stat(count)), 
                                     accuracy = 0.01)),
             vjust = 0.5)+
  scale_x_continuous(name = "Number of Claims")+
  scale_y_continuous(name = "Number of Polices", 
                     labels = label_number())+
  ggtitle("Proportion of policies by number of claims")
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_43_0.png)
    


We can compute the average claim frequency in this portfolio, taking into account the different exposures.


```R
scales::percent(sum(dataset$ClaimNb) / sum(dataset$Exposure), accuracy = 0.01)
```


'7.01%'


Let us now look at the other variables.

### Power

The variable **Power** is a categorized variable, related to the power of the car. The levels of the variable are ordered categorically.
We can see the different **levels** of a **factor** by using the function *level* in R:


```R
levels(dataset$Power)
```


<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'d'</li><li>'e'</li><li>'f'</li><li>'g'</li><li>'h'</li><li>'i'</li><li>'j'</li><li>'k'</li><li>'l'</li><li>'m'</li><li>'n'</li><li>'o'</li></ol>


We can see the number of observations in each level of the variable, by using the function *table*.

```R
table(dataset$Power)
```


    
        d     e     f     g     h     i     j     k     l     m     n     o 
    67660 76784 95432 90663 26558 17398 17978  9270  4593  1758  1276  1494 


Remember however, that in insurance, exposures may differ from one policyholder to another. Hence, the table above, does NOT measure the exposure in each level of the variable *Power*. We can use the functions *group_by* and *summarise* from package **dplyr** to give us the exposure in each level of the variable.

Check out the cheatsheet https://github.com/rstudio/cheatsheets/blob/main/data-transformation.pdf


```R
Power.summary = dataset %>% group_by(Power) %>% summarise(totalExposure = sum(Exposure),
                                                          Number.Observations = length(Exposure))
Power.summary
```


<table class="dataframe">
<caption>A tibble: 12 Ã— 3</caption>
<thead>
	<tr><th scope=col>Power</th><th scope=col>totalExposure</th><th scope=col>Number.Observations</th></tr>
	<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><td>d</td><td>37570.7285</td><td>67660</td></tr>
	<tr><td>e</td><td>44436.0602</td><td>76784</td></tr>
	<tr><td>f</td><td>55652.4991</td><td>95432</td></tr>
	<tr><td>g</td><td>51296.7035</td><td>90663</td></tr>
	<tr><td>h</td><td>13800.4918</td><td>26558</td></tr>
	<tr><td>i</td><td> 9244.0486</td><td>17398</td></tr>
	<tr><td>j</td><td> 9227.6339</td><td>17978</td></tr>
	<tr><td>k</td><td> 4493.4967</td><td> 9270</td></tr>
	<tr><td>l</td><td> 2134.1550</td><td> 4593</td></tr>
	<tr><td>m</td><td>  918.9622</td><td> 1758</td></tr>
	<tr><td>n</td><td>  642.0147</td><td> 1276</td></tr>
	<tr><td>o</td><td>  665.7642</td><td> 1494</td></tr>
</tbody>
</table>



We can show this on a plot as well:


```R
ggplot(Power.summary, aes(x=Power, 
                          y=totalExposure, 
                          fill=Power, 
                          color=Power, 
                          label=scales::number(totalExposure))) + 
  geom_bar(stat="identity")+
  geom_text(stat='identity',  vjust=-0.5)+
  scale_y_continuous(name = "Exposure in years", labels = scales::number)+
  scale_colour_discrete(guide = "none")+
  scale_fill_discrete(guide="none")
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_54_0.png)
    


Let us now look at the observed claim frequency in each level


```R
Power.summary = dataset %>% group_by(Power) %>% summarise(totalExposure = sum(Exposure),
                                                          Number.Observations = length(Exposure),
                                                          Number.Claims = sum(ClaimNb),
                                                          Obs.Claim.Frequency = sum(ClaimNb)/sum(Exposure))
Power.summary
```


<table class="dataframe">
<caption>A tibble: 12 Ã— 5</caption>
<thead>
	<tr><th scope=col>Power</th><th scope=col>totalExposure</th><th scope=col>Number.Observations</th><th scope=col>Number.Claims</th><th scope=col>Obs.Claim.Frequency</th></tr>
	<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><td>d</td><td>37570.7285</td><td>67660</td><td>2350</td><td>0.06254869</td></tr>
	<tr><td>e</td><td>44436.0602</td><td>76784</td><td>3198</td><td>0.07196858</td></tr>
	<tr><td>f</td><td>55652.4991</td><td>95432</td><td>3986</td><td>0.07162302</td></tr>
	<tr><td>g</td><td>51296.7035</td><td>90663</td><td>3450</td><td>0.06725578</td></tr>
	<tr><td>h</td><td>13800.4918</td><td>26558</td><td> 998</td><td>0.07231626</td></tr>
	<tr><td>i</td><td> 9244.0486</td><td>17398</td><td> 715</td><td>0.07734706</td></tr>
	<tr><td>j</td><td> 9227.6339</td><td>17978</td><td> 710</td><td>0.07694280</td></tr>
	<tr><td>k</td><td> 4493.4967</td><td> 9270</td><td> 375</td><td>0.08345394</td></tr>
	<tr><td>l</td><td> 2134.1550</td><td> 4593</td><td> 162</td><td>0.07590826</td></tr>
	<tr><td>m</td><td>  918.9622</td><td> 1758</td><td>  74</td><td>0.08052562</td></tr>
	<tr><td>n</td><td>  642.0147</td><td> 1276</td><td>  55</td><td>0.08566782</td></tr>
	<tr><td>o</td><td>  665.7642</td><td> 1494</td><td>  54</td><td>0.08110980</td></tr>
</tbody>
</table>



We can compute the ratio to the portfolio claim frequency and plot the claim frequencies.


```R
portfolio.cf = sum(dataset$ClaimNb)/ sum(dataset$Exposure)
# Can also be written as
portfolio.cf = with(dataset, sum(ClaimNb)/sum(Exposure))

ggplot(Power.summary, aes(x=Power, 
                          y=Obs.Claim.Frequency,
                          color=Obs.Claim.Frequency,
                          fill=Obs.Claim.Frequency,
                          label = percent(Obs.Claim.Frequency, accuracy = 0.01))) + 
  geom_bar(stat='identity') + 
  geom_hline(aes(yintercept=portfolio.cf), color="black", size= 2, linetype="dashed", alpha = 0.33) +
  geom_label(vjust=-0.21, fill="white", alpha = 0.25)+
  annotate(geom="text", 
           x='m', y=portfolio.cf, 
           vjust=-0.5, 
           label=paste("Average claim freq. of portfolio: ", percent(portfolio.cf, accuracy = 0.01)), 
           color="black")+
  scale_y_continuous(name = "Observed Claim Frequency", labels = percent_format(accuracy = 0.01))+
  theme(legend.position = 'none')
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_58_0.png)
    


### CarAge

The vehicle age, in years. This is the first continuous variable that we encounter (although it only takes discrete values).


```R
ggplot(dataset, 
       aes(x=CarAge)) + geom_bar()  + 
  scale_x_continuous(name = "Age of the Car", breaks=seq(0,100,5))+
  scale_y_continuous(name = "Number of Polices", labels=label_number())
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_60_0.png)
    


Alternatively, we can use a histogram, with a binwidth of 1.


```R
ggplot(dataset, 
       aes(x=CarAge)) + geom_histogram(binwidth = 1, color = 'black', fill='white')  + 
  scale_x_continuous(name = "Age of the Car", breaks=seq(0,100,5))+
  scale_y_continuous(name = "Number of Polices", labels=label_number())
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_62_0.png)
    


Again, here, the exposures are not considered on the barplot/histogram. We can use **ddply** to correct this.


```R
CarAge.summary = dataset %>% group_by(CarAge) %>% summarise(totalExposure = sum(Exposure),
                                                            Number.Observations = length(Exposure))
CarAge.summary
```


<table class="dataframe">
<caption>A tibble: 26 Ã— 3</caption>
<thead>
	<tr><th scope=col>CarAge</th><th scope=col>totalExposure</th><th scope=col>Number.Observations</th></tr>
	<tr><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><td> 0</td><td> 8710.9025</td><td>29984</td></tr>
	<tr><td> 1</td><td>18137.9287</td><td>37749</td></tr>
	<tr><td> 2</td><td>17347.0187</td><td>32505</td></tr>
	<tr><td> 3</td><td>15818.4690</td><td>28652</td></tr>
	<tr><td> 4</td><td>14966.3336</td><td>25761</td></tr>
	<tr><td> 5</td><td>14445.5049</td><td>23813</td></tr>
	<tr><td> 6</td><td>13790.1116</td><td>22433</td></tr>
	<tr><td> 7</td><td>12909.4805</td><td>20960</td></tr>
	<tr><td> 8</td><td>13084.2756</td><td>21091</td></tr>
	<tr><td> 9</td><td>12664.2031</td><td>20708</td></tr>
	<tr><td>10</td><td>13798.1326</td><td>24151</td></tr>
	<tr><td>11</td><td>12012.7075</td><td>19370</td></tr>
	<tr><td>12</td><td>11922.1309</td><td>19395</td></tr>
	<tr><td>13</td><td>11094.7754</td><td>18167</td></tr>
	<tr><td>14</td><td> 9932.9336</td><td>16511</td></tr>
	<tr><td>15</td><td> 8756.1514</td><td>15423</td></tr>
	<tr><td>16</td><td> 6263.4562</td><td>10430</td></tr>
	<tr><td>17</td><td> 4663.5321</td><td> 7762</td></tr>
	<tr><td>18</td><td> 3474.3392</td><td> 5707</td></tr>
	<tr><td>19</td><td> 2298.9654</td><td> 3821</td></tr>
	<tr><td>20</td><td> 1475.6669</td><td> 2433</td></tr>
	<tr><td>21</td><td>  960.0259</td><td> 1602</td></tr>
	<tr><td>22</td><td>  622.2193</td><td> 1006</td></tr>
	<tr><td>23</td><td>  412.2210</td><td>  638</td></tr>
	<tr><td>24</td><td>  303.0037</td><td>  450</td></tr>
	<tr><td>25</td><td>  218.0692</td><td>  342</td></tr>
</tbody>
</table>



Then, we can plot the data onto a barplot, as before.


```R
ggplot(CarAge.summary, aes(x=CarAge,
                          y=totalExposure, 
                          fill=factor(CarAge), 
                          color=factor(CarAge), 
                          label=label_number(accuracy=1)(totalExposure))) + 
  geom_bar(stat="identity")+
  geom_text(stat='identity', color="black", hjust=0.25, vjust=0.5,  angle=45, check_overlap=TRUE)+
  scale_x_continuous(breaks = seq(0,100,5))+
  scale_y_continuous(name = "Exposure in years", labels = label_number())+
  theme(legend.position = 'none')
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_66_0.png)
    


We can see a large difference, specially for new cars, which makes sense ! Indeed, let us look at the Exposure for recent vehicles, using a boxplot for instance.


```R
ggplot(dataset%>% filter(CarAge<5), aes(x=CarAge, y=Exposure,  group=CarAge)) + 
  geom_boxplot() +
  ggtitle("Exposure of recent cars")
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_68_0.png)
    


Let us now also compute the claim frequencies by age of car and plot them.


```R
CarAge.summary = dataset %>% group_by(CarAge) %>% summarise(totalExposure = sum(Exposure), 
                                                             Number.Observations = length(Exposure), 
                                                             Number.Claims = sum(ClaimNb), 
                                                             Obs.Claim.Freq = sum(ClaimNb)/sum(Exposure))

portfolio.cf = with(dataset, sum(ClaimNb)/ sum(Exposure))

ggplot(CarAge.summary, aes(x=CarAge, 
                          y=Obs.Claim.Freq,
                          label = percent(Obs.Claim.Freq, accuracy = 0.01))) + 
  geom_point() + geom_line()+
  geom_hline(yintercept=portfolio.cf, color="black", size= 2, linetype="dashed", alpha = 0.33) +
    annotate(geom="text", 
           x=20, y=portfolio.cf, 
           vjust=-0.5, 
           label=paste("Average claim freq. of portfolio: ", percent(portfolio.cf, accuracy = 0.01)), 
           color="black")+
  scale_x_continuous(name = "Age of the Car", breaks=seq(0,100,5))+
  scale_y_continuous(name = "Observed Claim Frequency", labels = percent_format(accuracy = 0.01))+
  theme(legend.position = 'none')

```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_70_0.png)
    


### DriverAge
Similarly to the Age of the Car, we can visualize the Age of the Drivers.


```R
DriverAge.summary = dataset %>% group_by(DriverAge) %>% summarise(totalExposure = sum(Exposure), 
                                                                  Number.Observations = length(Exposure), 
                                                                  Number.Claims = sum(ClaimNb), 
                                                                  Obs.Claim.Freq = sum(ClaimNb)/sum(Exposure))
head(DriverAge.summary,9)
```


<table class="dataframe">
<caption>A tibble: 9 Ã— 5</caption>
<thead>
	<tr><th scope=col>DriverAge</th><th scope=col>totalExposure</th><th scope=col>Number.Observations</th><th scope=col>Number.Claims</th><th scope=col>Obs.Claim.Freq</th></tr>
	<tr><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><td>18</td><td> 148.4220</td><td> 497</td><td> 46</td><td>0.3099271</td></tr>
	<tr><td>19</td><td> 636.9296</td><td>1610</td><td>171</td><td>0.2684755</td></tr>
	<tr><td>20</td><td>1020.8744</td><td>2529</td><td>216</td><td>0.2115833</td></tr>
	<tr><td>21</td><td>1277.9390</td><td>3040</td><td>207</td><td>0.1619796</td></tr>
	<tr><td>22</td><td>1562.9872</td><td>3548</td><td>239</td><td>0.1529123</td></tr>
	<tr><td>23</td><td>1830.1058</td><td>4156</td><td>230</td><td>0.1256758</td></tr>
	<tr><td>24</td><td>2162.8787</td><td>4862</td><td>230</td><td>0.1063398</td></tr>
	<tr><td>25</td><td>2495.9025</td><td>5556</td><td>240</td><td>0.0961576</td></tr>
	<tr><td>26</td><td>2937.4324</td><td>6468</td><td>312</td><td>0.1062152</td></tr>
</tbody>
</table>



We can show the Exposures by Age of the Driver...


```R
ggplot(DriverAge.summary, aes(x=DriverAge, y=totalExposure)) + 
  geom_bar(stat='identity', width=0.8) + 
  scale_y_continuous(name="Exposure in years", labels = label_number())+
  scale_x_continuous(name="Age of the Driver", breaks = seq(10,150,10))
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_74_0.png)
    


... and the observed claim frequency by Age.


```R
ggplot(DriverAge.summary, aes(x=DriverAge, y=Obs.Claim.Freq)) + 
  geom_line()+geom_point()+
  scale_y_continuous(name="Observed Claim Frequency", labels = percent, breaks = seq(0,0.50,0.05))+
  scale_x_continuous(name="Age of the Driver", breaks = seq(10,150,10))
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_76_0.png)
    


### Brand
The variable **Brand** is a categorized variable, related to the brand of the car. 
We can see the different *levels* of a *factor* by using the function **level** in R:


```R
levels(dataset$Brand)
```


<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'Fiat'</li><li>'Japanese (except Nissan) or Korean'</li><li>'Mercedes, Chrysler or BMW'</li><li>'Opel, General Motors or Ford'</li><li>'other'</li><li>'Renault, Nissan or Citroen'</li><li>'Volkswagen, Audi, Skoda or Seat'</li></ol>




```R
Brand.summary = dataset %>% group_by(Brand) %>% summarise(totalExposure = sum(Exposure), 
                                                          Number.Observations = length(Exposure), 
                                                          Number.Claims = sum(ClaimNb), 
                                                          Obs.Claim.Freq = sum(ClaimNb)/sum(Exposure))
                                          
Brand.summary
```


<table class="dataframe">
<caption>A tibble: 7 Ã— 5</caption>
<thead>
	<tr><th scope=col>Brand</th><th scope=col>totalExposure</th><th scope=col>Number.Observations</th><th scope=col>Number.Claims</th><th scope=col>Obs.Claim.Freq</th></tr>
	<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><td>Fiat                              </td><td>  9464.320</td><td> 16653</td><td> 714</td><td>0.07544123</td></tr>
	<tr><td>Japanese (except Nissan) or Korean</td><td> 31228.966</td><td> 79031</td><td>2078</td><td>0.06654079</td></tr>
	<tr><td>Mercedes, Chrysler or BMW         </td><td> 10392.166</td><td> 19087</td><td> 828</td><td>0.07967540</td></tr>
	<tr><td>Opel, General Motors or Ford      </td><td> 21733.558</td><td> 37287</td><td>1731</td><td>0.07964642</td></tr>
	<tr><td>other                             </td><td>  5676.076</td><td>  9738</td><td> 412</td><td>0.07258535</td></tr>
	<tr><td>Renault, Nissan or Citroen        </td><td>133460.245</td><td>216684</td><td>8905</td><td>0.06672399</td></tr>
	<tr><td>Volkswagen, Audi, Skoda or Seat   </td><td> 18127.227</td><td> 32384</td><td>1459</td><td>0.08048666</td></tr>
</tbody>
</table>




```R
ggplot(Brand.summary, aes(x=reorder(Brand,totalExposure), 
                          y=totalExposure, 
                          fill=Brand,
                          label = label_number()(totalExposure))) +
  geom_bar(stat='identity') +
  coord_flip()+guides(fill='none')+
  scale_x_discrete(name = "") + 
  scale_y_continuous("Exposure in years", labels = label_number(), expand = c(0.10, 0))+
  geom_label()
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_80_0.png)
    


Let us now look at the claim frequency by Brand of the car.


```R
ggplot(Brand.summary, aes(x=reorder(Brand,Obs.Claim.Freq), 
                          y=Obs.Claim.Freq, 
                          fill=Brand,
                          label = percent(Obs.Claim.Freq, accuracy=0.1))) +
  geom_bar(stat='identity') +
  geom_label(hjust=+1.2)+
  coord_flip()+guides(fill='none')+ ggtitle("Observed Claim Frequencies by Brand of the car")+
  scale_x_discrete(name = "Brand") + 
  scale_y_continuous("Observed claim Frequency", labels = percent)
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_82_0.png)
    


### Gas
The variable *Gas* is a categorized variable, related to the fuel of the car. 
We can see the different *levels* of a *factor* by using the function **level** in R:


```R
levels(dataset$Gas)
```


<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'Diesel'</li><li>'Regular'</li></ol>




```R
Gas.summary = dataset %>% group_by(Gas) %>% summarise(totalExposure = sum(Exposure), 
                                                      Number.Observations = length(Exposure), 
                                                      Number.Claims = sum(ClaimNb), 
                                                      Obs.Claim.Freq = sum(ClaimNb)/sum(Exposure))
ggplot(Gas.summary, aes(x=Gas, y=totalExposure, fill=Gas, label = number(totalExposure))) + 
  geom_bar(stat="identity") + 
  geom_label()+
  guides(fill='none')+
  scale_x_discrete(name = "Fuel")+
  scale_y_continuous(name='Total Exposure (in years)', labels = number)
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_85_0.png)
    


There seems to be a similar amount of Diesel and Regular gas vehicles in the portfolio.
It is generally expected that Diesel have a higher claim frequency. Does this also hold on our dataset ?


```R
ggplot(Gas.summary, 
       aes(x=Gas, y=Obs.Claim.Freq, 
           fill=Gas, 
           label = percent(Obs.Claim.Freq))) + 
  geom_bar(stat="identity") + 
  geom_label()+  guides(fill='none')+
  scale_x_discrete(name = "Fuel") + 
  scale_y_continuous("Observed claim Frequency", labels = percent)
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_87_0.png)
    


### Region
The variable *Region* is a categorized variable, related to the region of the place of residence. 
We can see the different *levels* of a *factor* by using the function **level** in R:


```R
levels(dataset$Region)
```


<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'Aquitaine'</li><li>'Basse-Normandie'</li><li>'Bretagne'</li><li>'Centre'</li><li>'Haute-Normandie'</li><li>'Ile-de-France'</li><li>'Limousin'</li><li>'Nord-Pas-de-Calais'</li><li>'Pays-de-la-Loire'</li><li>'Poitou-Charentes'</li></ol>



What are the Exposures in each region ? What are the observed claim frequencies ?


```R
Region.summary = dataset %>% group_by(Region) %>% summarize(totalExposure = sum(Exposure), 
                                                           Number.Observations = length(Exposure), 
                                                           Number.Claims = sum(ClaimNb), 
                                                           Obs.Claim.Freq = sum(ClaimNb)/sum(Exposure))
Region.summary
```


<table class="dataframe">
<caption>A tibble: 10 Ã— 5</caption>
<thead>
	<tr><th scope=col>Region</th><th scope=col>totalExposure</th><th scope=col>Number.Observations</th><th scope=col>Number.Claims</th><th scope=col>Obs.Claim.Freq</th></tr>
	<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><td>Aquitaine         </td><td> 14222.661</td><td> 31211</td><td>1052</td><td>0.07396647</td></tr>
	<tr><td>Basse-Normandie   </td><td>  6621.738</td><td> 10848</td><td> 451</td><td>0.06810900</td></tr>
	<tr><td>Bretagne          </td><td> 27656.640</td><td> 41986</td><td>1867</td><td>0.06750639</td></tr>
	<tr><td>Centre            </td><td>101843.464</td><td>159426</td><td>6460</td><td>0.06343068</td></tr>
	<tr><td>Haute-Normandie   </td><td>  3147.222</td><td>  8726</td><td> 219</td><td>0.06958517</td></tr>
	<tr><td>Ile-de-France     </td><td> 30016.992</td><td> 69576</td><td>2575</td><td>0.08578474</td></tr>
	<tr><td>Limousin          </td><td>  2376.002</td><td>  4539</td><td> 196</td><td>0.08249152</td></tr>
	<tr><td>Nord-Pas-de-Calais</td><td> 11346.794</td><td> 27111</td><td> 939</td><td>0.08275465</td></tr>
	<tr><td>Pays-de-la-Loire  </td><td> 21791.752</td><td> 38541</td><td>1569</td><td>0.07199972</td></tr>
	<tr><td>Poitou-Charentes  </td><td> 11059.292</td><td> 18900</td><td> 799</td><td>0.07224694</td></tr>
</tbody>
</table>



#### Creating Maps

We can plot a map with the observed claim frequencies and the total Exposure.
We first need to obtain the shape files (which contain the borders of each administrative area.)

1. Download shapefile from  http://www.diva-gis.org/gData
2. Extract all the files from the zip files, in a directory called shapefiles in your working directory


```R
area <- rgdal::readOGR("shapefiles/FRA_adm1.shp", use_iconv = TRUE, encoding = "UTF-8") # From http://www.diva-gis.org/gData

# Note that the tidy function will remove the data.
area_tidy = tidy(area) # package broom

#Plot an "empty" map
ggplot(area_tidy, aes(x = long, y = lat, group = group)) +
  geom_polygon(color = "black", size = 0.1, fill = "lightgrey") +
  coord_equal() + theme_void()
```

    OGR data source with driver: ESRI Shapefile 
    Source: "C:\Users\Florian\Documents\UCLouvain\Assurance Dommage\2023\UCLouvain-LACTU2110\1. Introduction\shapefiles\FRA_adm1.shp", layer: "FRA_adm1"
    with 22 features
    It has 9 fields
    Integer64 fields read as strings:  ID_0 ID_1 
    

    Regions defined for each Polygons
    
    


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_93_2.png)
    


We are now going to include our data into the map


```R
#First we re-include the data (that disappeared with the tidy function)
area$id <- row.names(area)
area_tidy2 <- area_tidy %>% full_join(area@data, by="id")

# Because of accents ...
area_tidy2$NAME_1 = stri_trans_general(str = area_tidy2$NAME_1, 
                   id = "Latin-ASCII")

# Which computed data do we want ?
data_to_add = Region.summary[,c("Region", "totalExposure", "Obs.Claim.Freq")]
# Merge it 
area_tidy2 <- area_tidy2 %>% full_join(data_to_add, by = c("NAME_1" = "Region"))

# Very important: Do not forget to sort by "order" variable.
# area_tidy2 = area_tidy2[order(area_tidy2$order),]
# Easier with dplyr:
area_tidy2 = area_tidy2 %>% arrange(order)

# Finally, plot the data: the claim frequencies
p1 = ggplot(area_tidy2, aes(long, lat, group=group, fill = Obs.Claim.Freq)) + ggtitle("Observed Claim Frequencies")+
  geom_polygon(color="black")+
  scale_fill_gradient(low = "green", high = "red", name="Obs. Claim Freq.")+
xlab("Longitude") + ylab("Latitude") + theme_void()

# and the exposures (on a log-scale)...
p2 = ggplot(area_tidy2, aes(long, lat, group=group, fill = log(totalExposure))) + ggtitle("log Exposures in years")+
  geom_polygon(color="black")+
  scale_fill_gradient(low = "green", high = "red", name="log Exposure")+
xlab("Longitude") + ylab("Latitude") + theme_void()


# Show them next to each other
gridExtra::grid.arrange(p1, p2, ncol=2)
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_95_0.png)
    


### Density
The Density represents here the density of the population at the place of residence.
Let us take a look at the densities in the dataset.



```R
summary(dataset$Density)
ggplot(dataset, aes(Density)) + geom_histogram(bins=200)
```


       Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
          2      67     288    1987    1414   27000 



    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_97_1.png)
    


Here, contrary to the age of the driver, or the age of the car, the density has lots of different values, as we can see below.


```R
length(unique(dataset$Density))
```


1270


Let us still compute as before the summary statistics and plot them ...


```R
Density.summary = dataset %>% group_by(Density) %>%
                   summarise(totalExposure = sum(Exposure), 
                                Number.Observations = length(Exposure), 
                                Number.Claims = sum(ClaimNb), 
                                Obs.Claim.Freq = sum(ClaimNb)/sum(Exposure))
ggplot(Density.summary, aes(x=Density, y=Obs.Claim.Freq)) + geom_point()
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_101_0.png)
    


... but realize it is impossible to see a trend. One way out is to categorize the variable. We will see later (GAM) that it is possible to estimate a smooth function, which avoid the arbitrary categorization.

We can categorize the variable using the function *cut*.


```R
dataset$DensityCAT = cut(dataset$Density, breaks = quantile(dataset$Density, probs = seq(from = 0, to = 1, by=0.1)),
                         include.lowest = TRUE)
table(dataset$DensityCAT)
levels(dataset$DensityCAT) <- LETTERS[1:10]
```


    
                 [2,28]             (28,51]             (51,91]            (91,159] 
                  41494               41173               41330               40432 
              (159,288]           (288,562]      (562,1.16e+03] (1.16e+03,2.41e+03] 
                  41028               41408               40889               41171 
    (2.41e+03,4.35e+03]  (4.35e+03,2.7e+04] 
                  42408               39531 


Then, we can apply the same strategy as above.


```R
Density.summary = dataset %>% group_by(DensityCAT) %>%
                  summarise(totalExposure = sum(Exposure), 
                            Number.Observations = length(Exposure), 
                            Number.Claims = sum(ClaimNb), 
                            Obs.Claim.Freq = sum(ClaimNb)/sum(Exposure))

ggplot(Density.summary, 
       aes(x=DensityCAT, 
           y=Obs.Claim.Freq, 
           fill=DensityCAT, 
           label = percent(Obs.Claim.Freq))) + 
  geom_bar(stat="identity") + 
  geom_label()+  guides(fill='none')+
  scale_x_discrete(name = "Density") + 
  scale_y_continuous("Observed claim Frequency", labels = percent)
```


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_105_0.png)
    


## Interactions

We can of course also dive into some interactions. For instance, we could analyse the effect of the car Age combined with the Fuel (Gas).

### Fuel and Car Age


```R
CarAge.Fuel.summary = dataset %>% group_by(CarAge, Gas) %>% 
                      summarise(totalExposure = sum(Exposure),
                                Number.Observations = length(Exposure),
                                Number.Claims = sum(ClaimNb),
                                Obs.Claim.Freq = sum(ClaimNb)/sum(Exposure))

ggplot(CarAge.Fuel.summary, aes(x=CarAge, 
                                y=Obs.Claim.Freq)) + 
  facet_wrap(~Gas)+
  geom_bar(stat="identity") + 
  scale_x_continuous(name = "Age of the Car", breaks=seq(0,100,5))+
  scale_y_continuous(name = "Observed Claim Frequency", labels = percent_format(accuracy = 0.01))+
  theme(legend.position = 'none')
```

    [1m[22m`summarise()` has grouped output by 'CarAge'. You can override using the `.groups` argument.
    


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_107_1.png)
    


### Fuel and Driver Age

We will illustrate another way to show this kind of data, by overlapping both bars.


```R
DriverAge.Fuel.summary = dataset %>% group_by(DriverAge, Gas) %>% 
                        summarize(Obs.Claim.Freq = sum(ClaimNb)/sum(Exposure))

ggplot(data=DriverAge.Fuel.summary, aes(x=DriverAge, 
                                        y=Obs.Claim.Freq, 
                                        fill=Gas, 
                                        color=Gas, 
                                        alpha=Gas)) +
  geom_bar(stat="identity", position ="identity") +
  scale_x_continuous(name = "Age of the Driver", breaks = seq(0,100,5))+
  scale_y_continuous(name = "Observed Claim Frequency", labels = label_percent())+
  scale_colour_manual(values=c("lightblue4", "red")) +
  scale_fill_manual(values=c("lightblue", "pink")) +
  scale_alpha_manual(values=c(.3, .8))+
  theme_bw()
```

    [1m[22m`summarise()` has grouped output by 'DriverAge'. You can override using the `.groups` argument.
    


    
![png](1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_files/1.%20Brief%20Introduction%20to%20R%20and%20Descriptive%20Analysis%20of%20the%20Dataset_109_1.png)
    


# Useful Links

- https://github.com/rstudio/cheatsheets/blob/main/data-transformation.pdf
- https://github.com/rstudio/cheatsheets/blob/main/data-visualization-2.1.pdf
